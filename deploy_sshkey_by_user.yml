---
- name: Deploy SSH key based on access log
  hosts: localhost
  gather_facts: no
  vars:
    access_log_file: "/home/adlet-test/ssh_center_access.log"
    ssh_key_repo: "https://gitlab.cl.nat.kz/adilet.jarassov/ssh-public-keys-storage/raw/main"
    ssh_key_file: "{{ tower_user_name }}"

  tasks:
    - name: Get target groups from access log
      command: "grep {{ ssh_key_file }} {{ access_log_file }}"
      register: access_log_output
      delegate_to: 172.17.3.68
      vars:
        ansible_ssh_user: adlet-test
        ansible_ssh_pass: "jhufybpfwbz"
      changed_when: false

    - name: Extract and deduplicate groups
      set_fact:
        target_groups: "{{ access_log_output.stdout | regex_findall('has access to (\\S+)') | unique }}"

- name: Deploy SSH key to authorized servers
  hosts: "{{ target_groups }}"
  gather_facts: no

  tasks:
    - name: Add SSH key to authorized_keys
      authorized_key:
        user: root
        state: present
        key: "{{ lookup('url', '{{ ssh_key_repo }}/{{ tower_user_name }}') }}"
        path: "/root/.ssh/authorized_keys"
      become: yes
